<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë§ˆì´í˜ì´ì§€ - AskMyFriend</title>
  <link rel="stylesheet" th:href="@{/css/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/mypage.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ì‚¬ì´ë“œë°” ê³ ì • & ë„ˆë¹„ ì§€ì • */
    .sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 250px;
      height: 100vh;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      box-sizing: border-box;
      z-index: 100; /* main-container ìœ„ì— */
    }
    /* main ì˜ì—­ì€ ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë„ì›Œì¤Œ */
    .main-container {
      margin-left: 250px;
      padding: 20px;
      background: var(--background-color);
      min-height: 100vh;
    }
    /* ì‚¬ì´ë“œë°” ì•„ë˜ìª½ í”„ë¡œí•„/ë²„íŠ¼ ê³ ì • */
    .sidebar-bottom {
  display: flex;
    flex-direction: column;
    gap: 50px;       /* ë²„íŠ¼ê³¼ í”„ë¡œí•„ ì‚¬ì´ ê°„ê²© */
    margin-top: auto;/* ì—¬ë°±ì„ ìœ„ë¡œ ë°€ì–´ì„œ sidebar í•˜ë‹¨ì— ë¶™ì„ */
    box-sizing: border-box;
        align-items: flex-start;
    }
    
    
/* í”„ë¡œí•„ì„ ì™¼ìª½ ì •ë ¬ */
.sidebar-bottom .profile-section {
  align-self: flex-start;
}

/* ìƒˆ ê¸€ì“°ê¸° ë²„íŠ¼ì€ í­ ê°€ë“ ì±„ìš°ë˜, í”„ë¡œí•„ê³¼ ê°„ê²© ìœ ì§€ */
.new-post-btn {
  width: 100%;
  /* margin-bottom: 10px; *//* gapìœ¼ë¡œ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ë³„ë„ ì—¬ë°± ë¶ˆí•„ìš” */
}
    /* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ì´ main ì½˜í…ì¸  ìœ„ë¡œ ë– ì˜¬ë¼ì˜¤ê²Œ */
    .profile-section {
      position: relative;
      z-index: 200;
    }
  </style>
</head>
<body>
  <!-- ========== ì‚¬ì´ë“œë°” ========== -->
  <div class="sidebar">
    <div>
      <div class="logo">AskMyFriend</div>
      <ul class="nav-menu">
        <li class="nav-item"><a th:href="@{/}" class="nav-link" data-path="/"><i class="fas fa-home"></i><span>í™ˆ</span></a></li>
        <li class="nav-item"><a th:href="@{/friends}" class="nav-link" data-path="/friends"><i class="fas fa-user-friends"></i><span>ì¹œêµ¬</span></a></li>
        <li class="nav-item"><a th:href="@{/subscriptions}" class="nav-link" data-path="/subscriptions"><i class="fas fa-rss"></i><span>êµ¬ë… ê´€ë¦¬</span></a></li>
        <li class="nav-item"><a th:href="@{/mypage}" class="nav-link" data-path="/mypage"><i class="fas fa-user"></i><span>ë‚´ í”„ë¡œí•„</span></a></li>
      </ul>
    </div>
    <div class="sidebar-bottom">
      <button type="button" class="new-post-btn" th:onclick="|location.href='@{/posts/new}'|">ìƒˆ ê¸€ì“°ê¸°</button>
      <div class="profile-section" id="sidebarProfile"       style="align-self:flex-start; margin-left:0; text-align:left;"
      >
        <div class="profile-dropdown">
          <a th:href="@{/mypage}" class="dropdown-link"><i class="fas fa-user"></i><span>ë‚´ í”„ë¡œí•„</span></a>
          <a th:href="@{/setting}" class="dropdown-link"><i class="fas fa-cog"></i><span>ì„¤ì •</span></a>
          <a th:href="@{/logout}" class="dropdown-link"><i class="fas fa-sign-out-alt"></i><span>ë¡œê·¸ì•„ì›ƒ</span></a>
        </div>
        <div class="profile-display">
          <img th:src="${user.profileImg != null ? user.profileImg : '/img/profile_default.jpg'}" class="profile-img" alt="í”„ë¡œí•„"/>
          <span class="profile-name" th:text="${user.username}">ì‚¬ìš©ì ì´ë¦„</span>
        </div>
      </div>
    </div>
  </div>
<div class="main-container"><!-- ë°°ê²½(ì»¤ë²„) ì´ë¯¸ì§€ -->
	    <div class="cover-bg">
	        <img th:if="${user.backgroundImg != null}" th:src="@{${user.backgroundImg}}" alt="ë°°ê²½ ì´ë¯¸ì§€" style="width:100%; height:200px; object-fit:cover;">
	        <img th:if="${user.backgroundImg == null}" th:src="@{/img/cover_default.jpg}" alt="ê¸°ë³¸ ë°°ê²½" style="width:100%; height:200px; object-fit:cover;">
	    </div>
	    
	    <div class="profile-section">
	        <div class="profile-circle">
	            <img th:if="${user.profileImg != null}" th:src="@{${user.profileImg}}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
	            <img th:if="${user.profileImg == null}" th:src="@{/img/profile_default.jpg}" alt="ê¸°ë³¸ í”„ë¡œí•„">
	        </div>
	        
	        <div class="profile-info">
	            <h2 th:text="${user.username}">ë‹‰ë„¤ì„</h2>
	            <div class="profile-meta">
	                <!-- â­ï¸ ì‹¤ì‹œê°„ íŒ”ë¡œìš° ìˆ˜ í‘œì‹œ -->
	                <span id="followingCount" th:text="${user.followingCount} + ' íŒ”ë¡œì‰'">0 íŒ”ë¡œì‰</span>
	                &nbsp;|&nbsp;
	                <span id="followerCount" th:text="${user.followerCount} + ' íŒ”ë¡œì›Œ'">0 íŒ”ë¡œì›Œ</span>
	                &nbsp;|&nbsp;
	                <!-- ê°€ì…ì¼ìë¥¼ ë…„/ì›”/ì¼ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • -->
	                <span th:if="${user.createdAt != null}" th:text="${#temporals.format(user.createdAt, 'yyyy/MM/dd')} + ' ê°€ì…'">2025/06/30 ê°€ì…</span>
	                <span th:if="${user.createdAt == null}">2025/06/30 ê°€ì…</span>
	                &nbsp;|&nbsp;
	                <!-- ê³µê°œë²”ìœ„ í‘œì‹œ -->
	                <span th:if="${user.privacy == 'private'}">ğŸ”’ë¹„ê³µê°œ</span>
	                <span th:if="${user.privacy != 'private'}">ğŸŒ ì „ì²´ê³µê°œ</span>
	            </div>
	            <div class="profile-desc" th:text="${user.bio}">ìê¸°ì†Œê°œ í…ìŠ¤íŠ¸</div>
	        </div>
	        
	        <!-- ë³¸ì¸ í˜ì´ì§€ì¼ ë•Œë§Œ í”„ë¡œí•„ ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ -->
	        <button th:if="${isOwner}" class="edit-btn" onclick="openModal()">í”„ë¡œí•„ ìˆ˜ì •</button>
	        
	        <!-- ë‹¤ë¥¸ ì‚¬ëŒ í˜ì´ì§€ì¼ ë•Œ íŒ”ë¡œìš° ë²„íŠ¼ í‘œì‹œ -->
	        <div th:if="${!isOwner}" class="follow-section">
	            <button class="follow-btn" id="followBtn" th:data-user-id="${user.loginId}" onclick="toggleFollow(this)">
	                íŒ”ë¡œìš°
	            </button>
	        </div>
	    </div>
	    
	    <!-- íƒ­ ë©”ë‰´ -->
	    <div class="tab-menu">
	        <button class="active" onclick="showTab('posts', this)">ê²Œì‹œë¬¼</button>
	        <button onclick="showTab('media', this)">ë¯¸ë””ì–´</button>
	        <button onclick="showTab('likes', this)">ë§ˆìŒì— ë“¤ì–´ìš”</button>
	    </div>
	    
	    <!-- íƒ­ë³„ ë‚´ìš© -->
	    <div id="tab-content">
	        <!-- ê²Œì‹œë¬¼ íƒ­ -->
	        <div id="posts" class="tab-pane">
	            <div th:each="post : ${posts}" class="post-item">
	                <a th:href="@{/posts/{postId}(postId=${post.id})}" style="text-decoration:none;">
	                    <!-- ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° í‘œì‹œ -->
	                    <div th:if="${post.imagePath != null and post.imagePath != ''}">
	                        <img th:src="@{${post.imagePath}}" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€" 
	                             style="width:100%; max-width:400px; height:auto; border-radius:8px; margin-bottom:12px;">
	                    </div>
	                    
	                    <h4 th:text="${post.content}">ê²Œì‹œë¬¼ ë‚´ìš©</h4>
	                    <p th:text="${post.content}">ê²Œì‹œë¬¼ ë‚´ìš©</p>
	                    <!-- ê²Œì‹œë¬¼ ì‘ì„±ì¼ë„ ë…„/ì›”/ì¼ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • -->
	                    <span th:if="${post.createdAt != null}" th:text="${#temporals.format(post.createdAt, 'yyyy/MM/dd')}">2025/06/30</span>
	                </a>
	            </div>
	            <div th:if="${posts == null or #lists.isEmpty(posts)}">
	                <p>ì‘ì„±í•œ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
	            </div>
	        </div>
	        
	        <!-- ë¯¸ë””ì–´ íƒ­ -->
	        <div id="media" class="tab-pane" style="display:none;">
	            <div class="media-grid">
	                <div th:each="media : ${mediaList}" class="media-item">
	                    <a th:href="@{/posts/{postId}(postId=${media.id})}">
	                        <img th:src="@{${media.imagePath}}" alt="ë¯¸ë””ì–´" 
	                             style="width:120px; height:120px; object-fit:cover; margin:5px; cursor:pointer; border-radius:8px;">
	                    </a>
	                </div>
	            </div>
	            <div th:if="${mediaList == null or #lists.isEmpty(mediaList)}">ì—…ë¡œë“œí•œ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
	        </div>
	        
	        <!-- ë§ˆìŒì— ë“¤ì–´ìš” íƒ­ -->
	        <div id="likes" class="tab-pane" style="display:none;">
	            <div th:each="like : ${likePosts}" class="like-item">
	                <a th:href="@{/posts/{postId}(postId=${like.id})}" style="text-decoration:none;">
	                    <div th:if="${like.imagePath != null and like.imagePath != ''}">
	                        <img th:src="@{${like.imagePath}}" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€" 
	                             style="width:100%; max-width:400px; height:auto; border-radius:8px; margin-bottom:12px;">
	                    </div>
	                    
	                    <h4 th:text="${like.content}">ì¢‹ì•„ìš”í•œ ê²Œì‹œë¬¼ ë‚´ìš©</h4>
	                    <p th:text="${like.content}">ê²Œì‹œë¬¼ ë‚´ìš©</p>
	                    <!-- ì¢‹ì•„ìš” ê²Œì‹œë¬¼ ë‚ ì§œë„ ë…„/ì›”/ì¼ í˜•ì‹ìœ¼ë¡œ ìˆ˜ì • -->
	                    <span th:if="${like.createdAt != null}" th:text="${#temporals.format(like.createdAt, 'yyyy/MM/dd')}">2025/06/30</span>
	                </a>
	            </div>
	            <div th:if="${likePosts == null or #lists.isEmpty(likePosts)}">ì¢‹ì•„ìš”í•œ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
	        </div>
	    </div>
	    
	    <!-- ë³¸ì¸ í˜ì´ì§€ì¼ ë•Œë§Œ í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ -->
	    <div th:if="${isOwner}" id="editModal">
	        <div class="modal-content">
	            <span class="close" onclick="closeModal()">&times;</span>
	            <form th:action="@{/mypage/updateProfile}" method="post" enctype="multipart/form-data">
	                <div class="cover-edit">
	                    <img id="coverPreview" th:if="${user.backgroundImg != null}" th:src="@{${user.backgroundImg}}" alt="ì»¤ë²„ ì´ë¯¸ì§€">
	                    <img id="coverPreview" th:if="${user.backgroundImg == null}" th:src="@{/img/cover_default.jpg}" alt="ê¸°ë³¸ ì»¤ë²„">
	                    <label>
	                        <input type="file" name="backgroundImg" accept="image/*" style="display:none;" onchange="previewCover(event)">
	                        <span style="font-size:18px;">&#9998;</span>
	                    </label>
	                </div>
	                
	                <div class="profile-edit">
	                    <div class="profile-img-wrapper">
	                        <img id="profilePreview" th:if="${user.profileImg != null}" th:src="@{${user.profileImg}}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
	                        <img id="profilePreview" th:if="${user.profileImg == null}" th:src="@{/img/profile_default.jpg}" alt="ê¸°ë³¸ í”„ë¡œí•„">
	                        <button type="button" class="edit-profile-btn" onclick="document.getElementById('profileImgInput').click()">
	                            &#9998;
	                        </button>
	                        <input type="file" id="profileImgInput" name="profileImg" accept="image/*" style="display:none;" onchange="previewProfile(event)">
	                    </div>
	                </div>
	                
	                <h2 style="margin-bottom:18px;font-size:1.3rem;">í”„ë¡œí•„ ìˆ˜ì •</h2>
	                <label>ë‹‰ë„¤ì„</label>
	                <input type="text" name="username" th:value="${user.username}" maxlength="30" required>
	                <label>ìê¸°ì†Œê°œ</label>
	                <textarea name="bio" rows="3" maxlength="300" th:text="${user.bio}"></textarea>
	                
	                <!-- ê³µê°œë²”ìœ„ ì„¤ì • -->
	                <label>ê³µê°œë²”ìœ„ ì„¤ì •</label>
	                <div class="custom-dropdown">
	                    <input type="hidden" name="privacy" id="privacyInput" th:value="${user.privacy != null ? user.privacy : 'public'}">
	                    <div class="dropdown-selected" id="dropdownSelected" onclick="toggleDropdown()">
	                        <span id="dropdownLabel" th:if="${user.privacy == 'public' or user.privacy == null}">ğŸŒ ì „ì²´ê³µê°œ</span>
	                        <span id="dropdownLabel" th:if="${user.privacy == 'private'}">ğŸ”’ë¹„ê³µê°œ</span>
	                        <span class="dropdown-arrow">&#9662;</span>
	                    </div>
	                    <div class="dropdown-options" id="dropdownOptions">
	                        <div class="dropdown-option" onclick="selectPrivacy('public', 'ğŸŒ ì „ì²´ê³µê°œ')">ğŸŒ ì „ì²´ê³µê°œ</div>
	                        <div class="dropdown-option" onclick="selectPrivacy('private', 'ğŸ”’ë¹„ê³µê°œ')">ğŸ”’ë¹„ê³µê°œ</div>
	                    </div>
	                </div>
	                
	                <button type="submit" class="edit-btn" style="width:100%;margin-top:20px;">ì €ì¥</button>
	            </form>
	        </div>
	    </div>
	</div>
	
	<script th:src="@{/js/mypage.js}"></script>
	
	<script>
	// â­ï¸ íŒ”ë¡œìš° ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
	function updateFollowCounts(followingCount, followerCount) {
	    document.getElementById('followingCount').textContent = followingCount + ' íŒ”ë¡œì‰';
	    document.getElementById('followerCount').textContent = followerCount + ' íŒ”ë¡œì›Œ';
	}
	
	// â­ï¸ íŒ”ë¡œìš° ê¸°ëŠ¥ (íŒ”ë¡œìš° ìˆ˜ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¶”ê°€)
	function toggleFollow(button) {
	    const userId = button.getAttribute('data-user-id');
	    const isFollowing = button.classList.contains('following');
	    
	    console.log('íŒ”ë¡œìš° í† ê¸€:', userId, 'í˜„ì¬ ìƒíƒœ:', isFollowing ? 'íŒ”ë¡œì‰' : 'íŒ”ë¡œìš°');
	    
	    if (isFollowing) {
	        if (!confirm('ì–¸íŒ”ë¡œìš°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
	            return;
	        }
	        
	        fetch(`/api/follow/by-login/${userId}`, {
	            method: 'DELETE'
	        })
	        .then(response => {
	            console.log('ì–¸íŒ”ë¡œìš° ì‘ë‹µ:', response.status);
	            if (response.ok) {
	                button.classList.remove('following');
	                button.textContent = 'íŒ”ë¡œìš°';
	                button.style.background = '#0a7cff';
	                button.style.color = '#fff';
	                
	                // â­ï¸ íŒ”ë¡œìš° ìˆ˜ ì—…ë°ì´íŠ¸
	                refreshFollowCounts(userId);
	                
	                console.log('ì–¸íŒ”ë¡œìš° ì„±ê³µ');
	            } else {
	                console.error('ì–¸íŒ”ë¡œìš° ì‹¤íŒ¨:', response.status);
	                alert('ì–¸íŒ”ë¡œìš°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
	            }
	        })
	        .catch(error => {
	            console.error('ì–¸íŒ”ë¡œìš° ì˜¤ë¥˜:', error);
	            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	        });
	    } else {
	        fetch(`/api/follow/by-login/${userId}`, {
	            method: 'POST'
	        })
	        .then(response => {
	            console.log('íŒ”ë¡œìš° ì‘ë‹µ:', response.status);
	            if (response.ok) {
	                button.classList.add('following');
	                button.textContent = 'íŒ”ë¡œì‰';
	                button.style.background = '#6c757d';
	                button.style.color = '#fff';
	                
	                // â­ï¸ íŒ”ë¡œìš° ìˆ˜ ì—…ë°ì´íŠ¸
	                refreshFollowCounts(userId);
	                
	                console.log('íŒ”ë¡œìš° ì„±ê³µ');
	            } else {
	                console.error('íŒ”ë¡œìš° ì‹¤íŒ¨:', response.status);
	                alert('íŒ”ë¡œìš°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
	            }
	        })
	        .catch(error => {
	            console.error('íŒ”ë¡œìš° ì˜¤ë¥˜:', error);
	            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	        });
	    }
	}
	
	// â­ï¸ íŒ”ë¡œìš° ìˆ˜ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
	function refreshFollowCounts(targetUserId) {
	    // í˜„ì¬ í˜ì´ì§€ì˜ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
	    const currentPageUserId = window.location.pathname.split('/').pop();
	    
	    // ë§ˆì´í˜ì´ì§€ ì •ë³´ ìƒˆë¡œê³ ì¹¨
	    fetch(`/api/mypage/info/${currentPageUserId}`)
	        .then(response => response.json())
	        .then(data => {
	            updateFollowCounts(data.followingCount, data.followerCount);
	        })
	        .catch(error => {
	            console.log('íŒ”ë¡œìš° ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
	        });
	}
	
	// â­ï¸ í˜ì´ì§€ ë¡œë“œ ì‹œ íŒ”ë¡œìš° ìƒíƒœ í™•ì¸
	document.addEventListener('DOMContentLoaded', function() {
	    const followBtn = document.getElementById('followBtn');
	    if (followBtn) {
	        const userId = followBtn.getAttribute('data-user-id');
	        console.log('íŒ”ë¡œìš° ìƒíƒœ í™•ì¸ ì‹œë„:', userId);
	        
	        fetch(`/api/follow/status-by-login/${userId}`)
	            .then(response => response.json())
	            .then(isFollowing => {
	                console.log('íŒ”ë¡œìš° ìƒíƒœ:', isFollowing);
	                if (isFollowing) {
	                    followBtn.classList.add('following');
	                    followBtn.textContent = 'íŒ”ë¡œì‰';
	                    followBtn.style.background = '#6c757d';
	                    followBtn.style.color = '#fff';
	                }
	            })
	            .catch(error => {
	                console.log('íŒ”ë¡œìš° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
	            });
	    }
	});
	</script>
	
	<style>
	/* íŒ”ë¡œìš° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.follow-section {
	    margin-left: 38px;
	}
	
	.follow-btn {
	    padding: 9px 26px;
	    background: #0a7cff;
	    color: #fff;
	    border: none;
	    border-radius: 22px;
	    font-size: 1.08rem;
	    cursor: pointer;
	    font-weight: bold;
	    transition: all 0.2s;
	}
	
	.follow-btn:hover {
	    background: #005ecb;
	    transform: translateY(-1px);
	}
	
	.follow-btn.following {
	    background: #6c757d;
	}
	
	.follow-btn.following:hover {
	    background: #e74c3c;
	}
	
	/* â­ï¸ íŒ”ë¡œìš° ìˆ˜ ìŠ¤íƒ€ì¼ ê°œì„  */
	.profile-meta span {
	    transition: all 0.3s ease;
	}
	
	#followingCount, #followerCount {
	    font-weight: 600;
	    color: #2c3e50;
	}
	</style>
	
	  <script>
	  document.addEventListener('DOMContentLoaded', () => {
		    const profileDisplay = document.querySelector('.profile-display');
		    const profileSection = document.querySelector('#sidebarProfile');

		    if (profileDisplay && profileSection) {
		      profileDisplay.addEventListener('click', () => {
		        profileSection.classList.toggle('show');
		      });

		      document.addEventListener('click', function(e) {
		        if (!profileSection.contains(e.target)) {
		          profileSection.classList.remove('show');
		        }
		      });
		    }
		  });

		  document.addEventListener('DOMContentLoaded', () => {
		    const currentPath = window.location.pathname;
		    document.querySelectorAll('.nav-link').forEach(link => {
		      const path = link.getAttribute('data-path');
		      if (currentPath === path || currentPath.startsWith(path + "/")) {
		        link.classList.add('active');
		      }
		    });
		  });
</script>
	
	</body>
	</html>
